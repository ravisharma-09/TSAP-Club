<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | TSAP Club</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body>
  <!-- Background -->
  <canvas id="matrixCanvas"></canvas>

  <!-- Content Wrapper -->
  <div id="app">
    <!-- Login View (Effectively a Modal overlaying the vibe) -->
    <div id="loginView" class="auth-container">
      <div class="glass-card auth-card">
        <div style="text-align: center; margin-bottom: 2rem;">
          <h2 class="text-gradient" style="font-size: 2rem; margin-bottom: 0.5rem;">Welcome Back</h2>
          <p class="text-secondary">Enter your credentials to access the terminal.</p>
        </div>

        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" id="loginEmail" class="form-input" placeholder="user@tsap.club">
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input type="password" id="loginPassword" class="form-input" placeholder="••••••••">
        </div>

        <button id="loginBtn" class="btn btn-primary" style="width: 100%;">Initialize Session</button>
      </div>
    </div>

    <!-- Dashboard View -->
    <div id="dashboardView" class="dashboard-grid" style="display: none;">

      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="logo" style="margin-bottom: 2rem;">
          <span class="text-gradient">TSAP</span> / DASH
        </div>

        <nav class="sidebar-nav">
          <div class="nav-item active">
            <i data-lucide="layout-dashboard"></i> Overview
          </div>
          <div class="nav-item">
            <i data-lucide="trophy"></i> Contests
          </div>
          <div class="nav-item">
            <i data-lucide="users"></i> Members
          </div>
          <div class="nav-item" style="margin-top: auto; color: var(--accent-red); cursor: pointer;" id="logoutBtn">
            <i data-lucide="log-out"></i> Disconnect
          </div>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="dashboard-content">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
          <div>
            <h1 style="font-size: 2rem;">System Overview</h1>
            <p class="text-secondary" id="welcomeMsg">Welcome back, User</p>
          </div>
          <div style="display: flex; gap: 1rem;">
            <button class="btn btn-outline" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
              <i data-lucide="refresh-cw" style="width: 1em; margin-right: 0.5rem;"></i> Sync
            </button>
          </div>
        </header>

        <!-- Bento Grid -->
        <div class="bento-grid">

          <!-- Main Stats -->
          <div class="glass-card col-span-8">
            <h3 style="margin-bottom: 1.5rem;">Performance Metrics</h3>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
              <div style="padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 8px;">
                <p class="text-secondary" style="font-size: 0.85rem;">TOTAL SOLVED</p>
                <h2 id="totalSolved" class="text-gradient" style="font-size: 2.5rem; margin-top: 0.5rem;">--</h2>
              </div>
              <div style="padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 8px;">
                <p class="text-secondary" style="font-size: 0.85rem;">ACCURACY</p>
                <h2 id="accuracy" class="text-gradient" style="font-size: 2.5rem; margin-top: 0.5rem;">--%</h2>
              </div>
              <div style="padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 8px;">
                <p class="text-secondary" style="font-size: 0.85rem;">STREAK</p>
                <h2 class="text-gradient" style="font-size: 2.5rem; margin-top: 0.5rem;">12</h2>
              </div>
            </div>
          </div>

          <!-- Profile / Quick Actions -->
          <div class="glass-card col-span-4"
            style="background: linear-gradient(135deg, rgba(249, 115, 22, 0.1) 0%, rgba(0,0,0,0) 100%);">
            <h3 style="margin-bottom: 1rem;">Status</h3>
            <div style="display: flex; flex-direction: column; gap: 1rem;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span class="text-secondary">Role</span>
                <span id="userRole"
                  style="padding: 0.2rem 0.6rem; background: var(--accent-orange); color: white; border-radius: 4px; font-size: 0.8rem; font-weight: 600;">ADMIN</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span class="text-secondary">Codeforces</span>
                <span id="cfHandle" style="font-family: monospace;">@ravisharma</span>
              </div>
            </div>
          </div>

          <!-- Leaderboard Table -->
          <div class="glass-card col-span-8">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h3>Club Rankings</h3>
              <button class="btn"
                style="padding: 0.25rem 0.5rem; font-size: 0.8rem; background: rgba(255,255,255,0.1);">View All</button>
            </div>
            <div class="table-container">
              <table id="membersTable">
                <thead>
                  <tr>
                    <th>Rank</th>
                    <th>Name</th>
                    <th>Codeforces</th>
                    <th>Rating</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Populated by JS -->
                  <tr>
                    <td colspan="4" style="text-align: center; color: var(--text-secondary);">Loading data stream...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Recommendations -->
          <div class="glass-card col-span-4">
            <h3>Next Mission</h3>
            <p class="text-secondary" style="font-size: 0.9rem; margin-bottom: 1rem;">Based on your recent activity.</p>

            <div id="recsList" style="display: flex; flex-direction: column; gap: 0.75rem;">
              <!-- Populated by JS -->
              <div style="padding: 0.75rem; border: 1px solid var(--glass-border); border-radius: 8px;">
                <div style="font-weight: 600; font-size: 0.9rem;">D. Valid BFS?</div>
                <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-top: 0.25rem;">
                  <span class="text-secondary">Graphs</span>
                  <span style="color: var(--accent-orange);">1800</span>
                </div>
              </div>
            </div>
          </div>

        </div>
      </main>
    </div>
  </div>

  <script src="visuals.js"></script>
  <script>
    lucide.createIcons();
  </script>
  <!-- Logic from original dashboard.html adapted -->
  <script>
    const API_BASE = '/api';

    // --- Auth Logic ---
    document.getElementById('loginBtn').addEventListener('click', async () => {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      try {
        const res = await fetch(`${API_BASE}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        if (res.ok) {
          const user = await res.json();
          showDashboard(user);
        } else {
          alert('Access Denied');
        }
      } catch (e) {
        console.error(e);
        alert('Connection Error');
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await fetch(`${API_BASE}/auth/logout`, { method: 'POST' });
      window.location.reload();
    });

    // --- Dashboard Logic ---
    async function checkSession() {
      try {
        const res = await fetch(`${API_BASE}/me`);
        if (res.ok) {
          const user = await res.json();
          showDashboard(user);
        } else {
          document.getElementById('loginView').style.display = 'flex';
        }
      } catch (e) {
        document.getElementById('loginView').style.display = 'flex';
      }
    }

    async function showDashboard(user) {
      document.getElementById('loginView').style.display = 'none';
      document.getElementById('dashboardView').style.display = 'grid'; // Note: grid for layout

      document.getElementById('welcomeMsg').textContent = `Welcome back, ${user.name}`;
      document.getElementById('userRole').textContent = user.role.toUpperCase();
      document.getElementById('cfHandle').textContent = user.handles.codeforces || 'N/A';

      loadStats(user);
      loadMembers();
    }

    async function loadStats(user) {
      try {
        // Fetch recommended problems specific to user (mocking call or real depending on backend)
        if (user.handles.codeforces) {
          const recRes = await fetch(`${API_BASE}/dashboard/recommendations?handle=${user.handles.codeforces}`);
          if (recRes.ok) {
            const recs = await recRes.json();
            renderRecs(recs);
          }
        }

        // Fetch Overview
        const overviewRes = await fetch(`${API_BASE}/dashboard/overview?codeforces=${user.handles.codeforces}`);
        if (overviewRes.ok) {
          const data = await overviewRes.json();
          document.getElementById('totalSolved').textContent = data.totalProblemsSolved || 0;
          document.getElementById('accuracy').textContent = (data.aggregatedAccuracy * 100).toFixed(1) + '%';
        }
      } catch (e) {
        console.error("Stats load fail:", e);
      }
    }

    function renderRecs(recs) {
      const list = document.getElementById('recsList');
      list.innerHTML = '';
      recs.slice(0, 3).forEach(prob => {
        const div = document.createElement('div');
        div.style.padding = '0.75rem';
        div.style.border = '1px solid var(--glass-border)';
        div.style.borderRadius = '8px';
        div.innerHTML = `
                    <div style="font-weight: 600; font-size: 0.9rem;">${prob.index}. ${prob.name}</div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-top: 0.25rem;">
                        <span class="text-secondary">${prob.tags[0] || 'Algo'}</span>
                        <span style="color: var(--accent-orange);">${prob.rating || '?'}</span>
                    </div>
                `;
        list.appendChild(div);
      });
    }

    async function loadMembers() {
      const tbody = document.querySelector('#membersTable tbody');
      try {
        // Using Leaderboard API
        const res = await fetch(`${API_BASE}/leaderboard`);
        const json = await res.json();
        const members = json.data || [];

        tbody.innerHTML = members.map((m, i) => `
                    <tr>
                        <td style="font-family:monospace; color: var(--accent-orange);">#${i + 1}</td>
                        <td style="font-weight: 600;">${m.name}</td>
                        <td>${m.handle}</td>
                        <td>${m.rating}</td>
                    </tr>
                `).join('');
      } catch (e) {
        tbody.innerHTML = '<tr><td colspan="4">Failed to load data</td></tr>';
      }
    }

    // Init
    checkSession();

    // Re-inject icons for dynamically added content if needed, though Lucide usually needs manual calls
    // We'll call it after render if necessary
  </script>
</body>

</html>